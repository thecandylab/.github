# .github/workflows/security-advisory-processor.yml
name: ğŸ›¡ï¸ Security Advisory Processor

on:
  security_advisory:
    types: [reported, published, updated]

jobs:
  process-advisory:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¨ Process New Security Advisory
        if: github.event.action == 'reported'
        uses: actions/github-script@v6
        with:
          script: |
            const advisory = context.payload.security_advisory;

            // Mapeo de severidad a tus etiquetas personalizadas
            const severityMapping = {
              'critical': { label: 'prio:P0', bounty: '$500-$1000' },
              'high': { label: 'prio:P1', bounty: '$250-$500' },
              'moderate': { label: 'prio:P2', bounty: '$100-$250' },
              'low': { label: 'prio:P3', bounty: 'Mention + Swag' }
            };

            const severityInfo = severityMapping[advisory.severity];

            // Crear issue interna de seguimiento (opcional)
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[SECURITY-TRACKING] ${advisory.summary}`,
              body: `
                ## ğŸ”’ Advisory de Seguridad - Seguimiento Interno

                **ID**: ${advisory.ghsa_id}
                **Severidad**: ${advisory.severity} (${severityInfo.label})
                **Reportado por**: ${advisory.reporter?.login || 'AnÃ³nimo'}
                **Bounty potencial**: ${severityInfo.bounty}

                ### ğŸ“‹ InformaciÃ³n del Advisory
                - **Estado**: En investigaciÃ³n
                - **Versiones afectadas**: ${advisory.vulnerabilities.map(v => v.package).join(', ')}
                - **CVE**: ${advisory.cve_id || 'Pendiente de asignaciÃ³n'}

                ### â±ï¸ Timeline Esperado
                - **Respuesta inicial**: ${severityInfo.response_time || '24-48h'}
                - **ResoluciÃ³n estimada**: ${severityInfo.resolution_time || '1-2 semanas'}

                [Ver Advisory](${advisory.html_url})
              `,
              labels: ['security-tracking', severityInfo.label, 'type:security']
            });

            // Enviar confirmaciÃ³n al reporter
            if (advisory.reporter) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: advisory.number,
                body: `
                  ## ğŸ¤ ConfirmaciÃ³n de RecepciÃ³n

                  Hemos recibido tu advisory de seguridad y estamos investigando.

                  **ğŸ“Š InformaciÃ³n inicial:**
                  - Severidad: ${advisory.severity}
                  - Bounty potencial: ${severityInfo.bounty}
                  - Estado: En investigaciÃ³n

                  **â±ï¸ PrÃ³ximos pasos:**
                  1. EvaluaciÃ³n tÃ©cnica (24-48 horas)
                  2. Desarrollo de parche (si es necesario)
                  3. CoordinaciÃ³n de divulgaciÃ³n
                  4. Actualizaciones regulares

                  **ğŸ“ Contacto:** security@thecandylab.com

                  ---
                  *Respuesta automÃ¡tica - Equipo de Seguridad The Candy Lab*
                `
              });
            }

  bounty-evaluation:
    runs-on: ubuntu-latest
    needs: process-advisory
    if: github.event.action == 'published'
    steps:
      - name: ğŸ† Evaluate Bounty Eligibility
        uses: actions/github-script@v6
        with:
          script: |
            const advisory = context.payload.security_advisory;

            // LÃ³gica de evaluaciÃ³n de recompensa
            const isEligible = advisory.severity === 'critical' || advisory.severity === 'high';

            if (isEligible && advisory.reporter) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: advisory.number,
                body: `
                  ## ğŸ† EvaluaciÃ³n de Recompensa

                  Â¡Tu reporte califica para nuestro programa de recompensas!

                  **ğŸ’° Bounty asignado:** ${advisory.severity === 'critical' ? '$500-$1000 USD' : '$250-$500 USD'}

                  **ğŸ“‹ PrÃ³ximos pasos:**
                  1. Nos pondremos en contacto via email en 5-7 dÃ­as
                  2. Proceso de verificaciÃ³n de identidad
                  3. Pago via mÃ©todo preferido

                  **ğŸ“§ Contacto:** security@thecandylab.com

                  Â¡Gracias por ayudar a mejorar nuestra seguridad!
                `
              });
            }
